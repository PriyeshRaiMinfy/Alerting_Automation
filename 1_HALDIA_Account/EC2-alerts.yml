groups:
  ## Server Status
  - name: server_alerts
    rules:

      # GENERIC ALERT - Fires for ANY node-linux that goes down (catches all, regardless of tags)
      # - alert: ServerDown
      #   expr: up == 0
      #   for: 5m
      #   labels:
      #     severity: critical
      #   annotations:
      #     summary: "Server {{ $labels.instance_name }} is down"
      #     description: "Critical: Server {{ $labels.instance_name }} is down. The server is not responding for the past 5 minutes."
      #     VALUE: "{{ $value }}"
      #     LABELS: "{{ $labels }}"

      # 1. Alert for EC2-start10AM
      - alert: ServerDown_EC2_start10AM
        expr: up{job="node-linux", EC2_start10AM=~"Yes|yes|True|true"} == 0
        for: 10s
        labels:
          severity: critical
          schedule: "10AM_Start"
        annotations:
          summary: "Scheduled Server {{ $labels.nodename }} (10AM) is down"
          description: "Server marked 'EC2-start10AM' is not responding. Instance: {{ $labels.instance }}"
          VALUE: "{{ $value }}"
          LABELS: "{{ $labels }}"

      # 2. Alert for EC2start
      - alert: ServerDown_EC2start
        expr: up{job="node-linux", EC2start=~"Yes|yes|True|true"} == 0
        for: 10s
        labels:
          severity: critical
          schedule: "Generic_Start"
        annotations:
          summary: "Scheduled Server {{ $labels.nodename }} is down"
          description: "Server marked 'EC2start' is not responding. Instance: {{ $labels.instance }}"
          VALUE: "{{ $value }}"
          LABELS: "{{ $labels }}"

      # 3. Alert for EC2start9AM (tag exists on pdemo-linux-server-3)
      - alert: ServerDown_EC2start9AM
        expr: up{job="node-linux", EC2start9AM=~"Yes|yes|True|true"} == 0
        for: 10s
        labels:
          severity: critical
          schedule: "9AM_Start"
        annotations:
          summary: "Scheduled Server {{ $labels.nodename }} (9AM) is down"
          description: "Server marked 'EC2start9AM' is not responding. Instance: {{ $labels.instance }}"
          VALUE: "{{ $value }}"
          LABELS: "{{ $labels }}"

      # 4. Alert for EC2start10AM (No Hyphen)
      - alert: ServerDown_EC2start10AM
        expr: up{job="node-linux", EC2start10AM=~"Yes|yes|True|true"} == 0
        for: 10s
        labels:
          severity: critical
          schedule: "10AM_Start_NoHyphen"
        annotations:
          summary: "Scheduled Server {{ $labels.nodename }} is down"
          description: "Server marked 'EC2start10AM' is not responding. Instance: {{ $labels.instance }}"
          VALUE: "{{ $value }}"
          LABELS: "{{ $labels }}"

      # 5. Alert for QAEC2DBstart
      - alert: ServerDown_QAEC2DBstart
        expr: up{job="node-linux", QAEC2DBstart=~"Yes|yes|True|true"} == 0
        for: 10s
        labels:
          severity: critical
          schedule: "QA_DB_Start"
        annotations:
          summary: "QA Database Server {{ $labels.nodename }} is down"
          description: "Server marked 'QAEC2DBstart' is not responding. Instance: {{ $labels.instance }}"
          VALUE: "{{ $value }}"
          LABELS: "{{ $labels }}"

# -----------------------------------------------------------------------------------------
  ## Disk Usage
  - name: disk_usage_alerts
    rules:
      - alert: DiskUsageTrouble
        expr: ((node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"} - node_filesystem_free_bytes)
              / node_filesystem_size_bytes *100) >= 75
        for: 5m
        labels:
          severity: trouble
        annotations:
          summary: "High disk usage on {{ $labels.nodename }}"
          description: "Disk usage exceeded 75% on {{ $labels.mountpoint }}."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: '{{ $labels }}'

      - alert: DiskUsageCritical
        expr: ((node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"} - node_filesystem_free_bytes)
              / node_filesystem_size_bytes *100) >= 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Critical disk usage on {{ $labels.nodename }}"
          description: "Disk usage exceeded 90% on {{ $labels.mountpoint }}."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: '{{ $labels }}'

  ## Memory Usage
  - name: memory_alerts
    rules:
      - alert: MemoryUsageCritical
        expr: 100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) >= 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Critical memory usage on {{ $labels.nodename }}"
          description: "Memory usage above 90%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

      - alert: MemoryUsageTrouble
        expr: 100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) >= 70
        for: 5m
        labels:
          severity: trouble
        annotations:
          summary: "High memory usage on {{ $labels.nodename }}"
          description: "Memory usage above 70%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

  ## Swap Memory
  - name: swapmemory_alerts
    rules:
      - alert: SwapUsageCritical
        expr: ((node_memory_SwapTotal_bytes - node_memory_SwapFree_bytes)
                / node_memory_SwapTotal_bytes * 100) > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Critical swap usage on {{ $labels.nodename }}"
          description: "Swap usage above 90%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

      - alert: SwapUsageTrouble
        expr: ((node_memory_SwapTotal_bytes - node_memory_SwapFree_bytes)
                / node_memory_SwapTotal_bytes * 100) > 75
        for: 5m
        labels:
          severity: trouble
        annotations:
          summary: "High swap usage on {{ $labels.nodename }}"
          description: "Swap usage above 75%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

  ## CPU Load - Linux
  - name: cpu_alerts
    rules:
      - alert: CpuLoadCritical
        expr: 100 - (avg by(nodename) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Critical CPU load on {{ $labels.nodename }}"
          description: "CPU load above 90%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

      - alert: CpuLoadTrouble
        expr: 100 - (avg by(nodename) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 75
        for: 5m
        labels:
          severity: trouble
        annotations:
          summary: "High CPU load on {{ $labels.nodename }}"
          description: "CPU load above 75%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

  ## Windows Disk
  - name: windows_drive_disk_usage
    rules:
      - alert: WindowsDiskUsageTrouble
        expr: ((windows_logical_disk_size_bytes - windows_logical_disk_free_bytes)
                / windows_logical_disk_size_bytes * 100) >= 75
        for: 5m
        labels:
          severity: trouble
        annotations:
          summary: "Windows disk usage high on {{ $labels.instance_name }}"
          description: "Disk usage above 75% on volume {{ $labels.volume }}."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: '{{ $labels }}'

      - alert: WindowsDiskUsageCritical
        expr: ((windows_logical_disk_size_bytes - windows_logical_disk_free_bytes)
                / windows_logical_disk_size_bytes * 100) >= 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Windows disk usage critical on {{ $labels.instance_name }}"
          description: "Disk usage above 90% on volume {{ $labels.volume }}."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: '{{ $labels }}'

  ## Windows Memory
  - name: windows_memory_usage
    rules:
      - alert: WindowsMemoryUsageTrouble
        expr: (100 - 100 * windows_os_physical_memory_free_bytes / windows_cs_physical_memory_bytes) >= 75
        for: 5m
        labels:
          severity: trouble
        annotations:
          summary: "Windows memory usage high on {{ $labels.instance_name }}"
          description: "Memory usage above 75%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

      - alert: WindowsMemoryUsageCritical
        expr: (100 - 100 * windows_os_physical_memory_free_bytes / windows_cs_physical_memory_bytes) >= 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Windows memory usage critical on {{ $labels.instance_name }}"
          description: "Memory usage above 90%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

  ## Windows CPU
  - name: windows_cpu_usage
    rules:
      - alert: WindowsCpuLoadTrouble
        expr: 100 - (avg by(instance_name) (rate(windows_cpu_time_total{mode="idle"}[5m])) * 100) > 75
        for: 5m
        labels:
          severity: trouble
        annotations:
          summary: "Windows CPU high on {{ $labels.instance_name }}"
          description: "CPU load above 75%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"

      - alert: WindowsCpuLoadCritical
        expr: 100 - (avg by(instance_name) (rate(windows_cpu_time_total{mode="idle"}[5m])) * 100) > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Windows CPU critical on {{ $labels.instance_name }}"
          description: "CPU load above 90%."
          VALUE: '{{ printf "%.2f" $value }}%'
          LABELS: "{{ $labels }}"